---
title: "Cleaning"
author: "Alex Kan -lexokan"
date: "April 7, 2018"
output: html_document
---

```{r}
library(tidyverse)
library(tensorflow)
```

```{r}
sample <- read_csv("data/sample.csv")
salaries <- read_csv("data/salary.csv")
```

```{r}
### DATA CLEANING

# Select columns, and focus only on continental US

df <- sample %>% 
    select(date, companyId, jobId, country, stateProvince, city, avgOverallRating, numReviews, normTitleCategory, supervisingJob, descriptionCharacterLength, descriptionWordCount, estimatedSalary, educationRequirement, clicks, jobAgeDays, localClicks) %>% 
    filter(country == "US", stateProvince != "PR", stateProvince != "VI") 

# Create dummy variables for number of reviews 

df$numReviews <- ifelse(is.na(df$numReviews), 0, df$numReviews)
df$numReviews <- ifelse(df$numReviews > mean(df$numReviews), "many", ifelse(df$numReviews > 0, "few", "none"))

df$isFew <- ifelse(df$numReviews == "few", .33, 0)
df$isMany <- ifelse(df$numReviews == "many", .33, 0)

# Remove outliers for Word Count and Character Length
df$descriptionWordCount <- ifelse(df$descriptionWordCount > 2.5 * sd(df$descriptionWordCount), median(df$descriptionWordCount), df$descriptionWordCount)

df$descriptionCharacterLength <- ifelse(df$descriptionCharacterLength > 2.5 * sd(df$descriptionCharacterLength), median(df$descriptionCharacterLength), df$descriptionCharacterLength)

# Create Normalized Salaries
matchIndicies <- match(df$stateProvince, salaries$State)
df$normSalary <- df$estimatedSalary / salaries[matchIndicies, 2]

# Date formatting, add season dummy variables 
df$date <- as.Date(df$date)
df <- filter(df, df$date < "2017-10-01")
df$date <- format(df$date, format = "%m")
df$date <- as.numeric(df$date)

df$jobAgeDays <- ifelse(df$jobAgeDays == 0, 1, df$jobAgeDays)
df$avgLocalClick <- (df$localClicks)/(df$jobAgeDays)

df$isWinter <- ifelse(df$date <= 3, 0.25, 0)
df$isSpring <- ifelse(df$date >= 4, ifelse(df$date <= 6, 0.25,0), 0)
df$isSummer <- ifelse(df$date >= 7, ifelse(df$date <= 9, 0.25,0), 0)


# Remove variables that are used to create dummies 
df <- df %>%
    select(-numReviews, -supervisingJob, -avgOverallRating) %>%
    filter(is.na(normSalary) == F)

```




```{r}

# Get top 100 cities 
cities <- df %>%
    select(city, stateProvince) %>%
    group_by(city) %>%
    summarise(n = n()) %>%
    arrange(desc(n)) %>% 
    slice(1:100)

# Group states 
states <- df %>%
    select(city, stateProvince) %>%
    group_by(stateProvince) %>%
    summarise(n = n()) %>%
    arrange(desc(n))

 
```




